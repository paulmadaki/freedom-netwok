<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Register - Freedom Network</title>
  <!-- Tailwind CSS for styling -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  
  <!-- Custom responsive styles for mobile devices -->
  <style>
    @media (max-width: 640px) {
      body {
        padding: 0 !important;
      }
      /* Reduce padding on main content areas for mobile */
      main, .main-content {
        padding: 0.5rem !important;
      }
      /* Make grid single column on mobile */
      .grid {
        grid-template-columns: 1fr !important;
        gap: 1rem !important;
      }
      /* Add spacing between white sections */
      .bg-white {
        margin-bottom: 1rem;
      }
      /* Full width containers on mobile */
      .max-w-4xl, .max-w-6xl {
        max-width: 100vw !important;
      }
      /* Reduce font sizes for mobile readability */
      .text-2xl, .text-xl, .text-lg {
        font-size: 1.1rem !important;
      }
      /* Consistent padding for mobile */
      .p-4 {
        padding: 1rem !important;
      }
    }

    /* Loading spinner styles */
    .spinner {
      border: 4px solid #f3f4f6;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-message {
      background-color: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      display: none;
    }

    .success-message {
      background-color: #f0fdf4;
      border: 1px solid #bbf7d0;
      color: #16a34a;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      display: none;
    }

    .form-loading {
      opacity: 0.6;
      pointer-events: none;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- Welcome banner at the top of the page -->
  <div class="bg-blue-600 text-white text-center py-4 font-semibold text-lg shadow mb-4">
    Welcome! You're about to join Freedom Network and start your journey to online wealth.
  </div>

  <!-- Platform information and benefits section -->
  <section class="bg-white py-8 px-4 md:px-0 mb-6">
    <div class="max-w-2xl mx-auto text-center">
      <!-- Platform description -->
      <h2 class="text-2xl font-bold text-blue-700 mb-4">What is Freedom Network?</h2>
      <p class="text-base mb-4 text-gray-700">
        Freedom Network is a one-time payment affiliate platform designed to help you earn passively and actively.
        When you join, you get instant access to our premium digital product, and you unlock the opportunity to earn by sharing our platform with others.
      </p>
      
      <!-- Digital product benefits -->
      <h3 class="text-xl font-semibold text-green-700 mb-2">Why Buy Our Digital Product?</h3>
      <ul class="text-left max-w-xl mx-auto mb-4 text-gray-800 list-disc list-inside">
        <li>Instant access to valuable digital resources (eBooks, guides, or courses) that help you grow personally and financially.</li>
        <li>One-time payment—no hidden fees or subscriptions.</li>
        <li>Lifetime access to updates and new releases.</li>
      </ul>
      
      <!-- Affiliate program benefits -->
      <h3 class="text-xl font-semibold text-green-700 mb-2">Benefits of Becoming an Affiliate</h3>
      <ul class="text-left max-w-xl mx-auto mb-4 text-gray-800 list-disc list-inside">
        <li>Earn direct commissions for every person you refer.</li>
        <li>Benefit from our unique matrix system and passive pool earnings.</li>
        <li>Withdraw your earnings easily and securely.</li>
        <li>Get access to exclusive training and support.</li>
        <li>Be part of a growing community focused on financial freedom.</li>
      </ul>
    </div>
  </section>

  <!-- Main registration form section -->
  <div class="min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
      <h2 class="text-2xl font-bold mb-4 text-center text-blue-600">Join Freedom Network</h2>
      
      <!-- Error and Success Messages -->
      <div id="errorMessage" class="error-message"></div>
      <div id="successMessage" class="success-message"></div>
      
      <!-- Registration form with payment integration -->
      <form id="registrationForm">
        <!-- Full name input field -->
        <div class="mb-4">
          <label class="block mb-1 font-medium" for="name">Full Name</label>
          <input 
            type="text" 
            id="name" 
            name="name"
            required 
            minlength="2"
            maxlength="100"
            class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" 
            placeholder="Enter your full name"
          />
          <div class="text-red-500 text-sm mt-1 hidden" id="nameError"></div>
        </div>
        
        <!-- Email input field -->
        <div class="mb-4">
          <label class="block mb-1 font-medium" for="email">Email Address</label>
          <input 
            type="email" 
            id="email" 
            name="email"
            required 
            maxlength="255"
            class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" 
            placeholder="Enter your email address"
          />
          <div class="text-red-500 text-sm mt-1 hidden" id="emailError"></div>
        </div>
        
        <!-- Phone number input field -->
        <div class="mb-4">
          <label class="block mb-1 font-medium" for="phone">Phone Number</label>
          <input 
            type="tel" 
            id="phone" 
            name="phone"
            required 
            pattern="[0-9+\-() ]+"
            maxlength="20"
            class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" 
            placeholder="Enter your phone number"
          />
          <div class="text-red-500 text-sm mt-1 hidden" id="phoneError"></div>
        </div>
        
        <!-- Password input with strength indicator -->
        <div class="mb-4">
          <label class="block mb-1 font-medium" for="password">Password</label>
          <input 
            type="password" 
            id="password" 
            name="password"
            required 
            minlength="6"
            maxlength="128"
            class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" 
            placeholder="Create a strong password"
          />
          <!-- Show/hide password toggle -->
          <label class="flex items-center mt-2 cursor-pointer">
            <input type="checkbox" id="showPassword" class="mr-2" />
            <span class="text-sm">Show Password</span>
          </label>
          <!-- Password strength indicator -->
          <div id="passwordStrength" class="mt-2 text-sm font-semibold"></div>
          <div class="text-red-500 text-sm mt-1 hidden" id="passwordError"></div>
        </div>
        
        <!-- Confirm Password -->
        <div class="mb-4">
          <label class="block mb-1 font-medium" for="confirmPassword">Confirm Password</label>
          <input 
            type="password" 
            id="confirmPassword" 
            name="confirmPassword"
            required 
            class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" 
            placeholder="Confirm your password"
          />
          <div class="text-red-500 text-sm mt-1 hidden" id="confirmPasswordError"></div>
        </div>
        
        <!-- Optional referral code field -->
        <div class="mb-4">
          <label class="block mb-1 font-medium" for="referral">Referral Code (optional)</label>
          <input 
            type="text" 
            id="referral" 
            name="referral"
            maxlength="200"
            class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" 
            placeholder="Enter referral code if you have one"
          />
        </div>

        <!-- Terms and Conditions -->
        <div class="mb-4">
          <label class="flex items-start cursor-pointer">
            <input type="checkbox" id="agreeTerms" required class="mr-2 mt-1" />
            <span class="text-sm text-gray-700">
              I agree to the <a href="terms.html" class="text-blue-600 hover:underline" target="_blank" rel="noopener">Terms and Conditions</a> 
              and <a href="privacy.html" class="text-blue-600 hover:underline" target="_blank" rel="noopener">Privacy Policy</a>
            </span>
          </label>
          <div class="text-red-500 text-sm mt-1 hidden" id="termsError"></div>
        </div>
        
        <!-- Submit button that triggers payment -->
        <button 
          type="submit" 
          id="submitButton"
          class="bg-blue-600 text-white px-4 py-2 w-full rounded hover:bg-blue-700 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span id="buttonText">Pay ₦7,500 & Register</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Paystack payment gateway script -->
  <script src="https://js.paystack.co/v1/inline.js"></script>

  <!-- Main Application Script -->
  <script type="module">
    // --- Firebase imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, fetchSignInMethodsForEmail } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import { getFirestore, setDoc, doc, updateDoc, getDoc, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    // --- Configuration ---
    const CONFIG = {
      firebase: {
        apiKey: "AIzaSyDauAhAQEbFZcaj4hTnQsi1sjZP4FiQj4Y",
        authDomain: "polo-tech-media-network-49de0.firebaseapp.com",
        projectId: "polo-tech-media-network-49de0",
        storageBucket: "polo-tech-media-network-49de0.appspot.com",
        messagingSenderId: "825576121343",
        appId: "1:825576121343:web:6d0f8593e2be4c34a3bdca"
      },
      paystack: {
        publicKey: 'pk_live_98e672f88208c8d3bb0c4bc7439883ad7e29ad94',
        amount: 750000, // ₦7,500 in kobo
        currency: 'NGN'
      },
      validation: {
        minPasswordLength: 6,
        maxRetries: 3
      }
    };

    // --- Initialize Firebase ---
    const app = initializeApp(CONFIG.firebase);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Application State ---
    const AppState = {
      isLoading: false,
      retryCount: 0,
      formData: {},
      passwordStrength: {
        isStrong: false,
        score: 0
      }
    };

    // --- DOM Elements ---
    const elements = {
      form: document.getElementById('registrationForm'),
      submitButton: document.getElementById('submitButton'),
      buttonText: document.getElementById('buttonText'),
      errorMessage: document.getElementById('errorMessage'),
      successMessage: document.getElementById('successMessage'),
      passwordInput: document.getElementById('password'),
      confirmPasswordInput: document.getElementById('confirmPassword'),
      showPasswordCheckbox: document.getElementById('showPassword'),
      passwordStrength: document.getElementById('passwordStrength')
    };

    // --- Utility Functions ---
    const Utils = {
      showError(message) {
        elements.errorMessage.textContent = message;
        elements.errorMessage.style.display = 'block';
        elements.successMessage.style.display = 'none';
        setTimeout(() => {
          elements.errorMessage.style.display = 'none';
        }, 5000);
      },
      showSuccess(message) {
        elements.successMessage.textContent = message;
        elements.successMessage.style.display = 'block';
        elements.errorMessage.style.display = 'none';
      },
      showFieldError(fieldId, message) {
        const errorElement = document.getElementById(`${fieldId}Error`);
        if (errorElement) {
          errorElement.textContent = message;
          errorElement.classList.remove('hidden');
        }
      },
      hideFieldError(fieldId) {
        const errorElement = document.getElementById(`${fieldId}Error`);
        if (errorElement) {
          errorElement.classList.add('hidden');
        }
      },
      setLoading(loading) {
        AppState.isLoading = loading;
        elements.submitButton.disabled = loading;
        if (loading) {
          elements.form.classList.add('form-loading');
          elements.buttonText.innerHTML = '<div class="spinner"></div>Processing...';
        } else {
          elements.form.classList.remove('form-loading');
          elements.buttonText.textContent = 'Pay ₦7,500 & Register';
        }
      },
      sanitizeInput(input) {
        return input.trim().replace(/[<>]/g, '');
      },
      validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      },
      validatePhone(phone) {
        const phoneRegex = /^[0-9+\-\s()]+$/;
        return phoneRegex.test(phone) && phone.length >= 10;
      },
      generateTransactionRef() {
        return 'FN_' + Date.now() + '_' + Math.floor(Math.random() * 1000000);
      }
    };

    // --- Password Strength Checker ---
    elements.passwordInput.addEventListener('input', function() {
      const password = this.value;
      const strengthDiv = elements.passwordStrength;
      let score = 0, missing = [];
      if (password.length >= 8) score++; else missing.push('8+ chars');
      if (/[A-Z]/.test(password)) score++; else missing.push('uppercase');
      if (/[a-z]/.test(password)) score++; else missing.push('lowercase');
      if (/\d/.test(password)) score++; else missing.push('number');
      if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) score++; else missing.push('symbol');
      let strengthText = '', color = '';
      if (score <= 1) { strengthText = 'Very Weak'; color = 'text-red-600'; }
      else if (score === 2) { strengthText = 'Weak'; color = 'text-orange-600'; }
      else if (score === 3) { strengthText = 'Fair'; color = 'text-yellow-600'; }
      else if (score === 4) { strengthText = 'Good'; color = 'text-blue-600'; }
      else { strengthText = 'Strong'; color = 'text-green-600'; }
      const needText = missing.length > 0 ? `Need: ${missing.join(', ')}` : 'Excellent!';
      strengthDiv.innerHTML = `<span class="${color}">Strength: ${strengthText}</span><br><span class="text-xs text-gray-600">${needText}</span>`;
    });

    // --- Confirm Password Validation ---
    elements.confirmPasswordInput.addEventListener('input', function() {
      const errorDiv = document.getElementById('confirmPasswordError');
      if (this.value && elements.passwordInput.value !== this.value) {
        errorDiv.textContent = 'Passwords do not match';
        errorDiv.classList.remove('hidden');
      } else {
        errorDiv.classList.add('hidden');
      }
    });

    // --- Show/Hide Password ---
    elements.showPasswordCheckbox.addEventListener('change', function() {
      const type = this.checked ? 'text' : 'password';
      elements.passwordInput.type = type;
      elements.confirmPasswordInput.type = type;
    });

    // --- Form Validation ---
    const FormValidator = {
      validateField(fieldId, value) {
        Utils.hideFieldError(fieldId);
        switch (fieldId) {
          case 'name':
            if (!value || value.length < 2) {
              Utils.showFieldError(fieldId, 'Name must be at least 2 characters long');
              return false;
            }
            break;
          case 'email':
            if (!Utils.validateEmail(value)) {
              Utils.showFieldError(fieldId, 'Please enter a valid email address');
              return false;
            }
            break;
          case 'phone':
            if (!Utils.validatePhone(value)) {
              Utils.showFieldError(fieldId, 'Please enter a valid phone number');
              return false;
            }
            break;
          case 'password':
            if (value.length < CONFIG.validation.minPasswordLength) {
              Utils.showFieldError(fieldId, `Password must be at least ${CONFIG.validation.minPasswordLength} characters long`);
              return false;
            }
            break;
          case 'confirmPassword':
            const password = elements.passwordInput.value;
            if (value !== password) {
              Utils.showFieldError(fieldId, 'Passwords do not match');
              return false;
            }
            break;
          case 'agreeTerms':
            if (!document.getElementById('agreeTerms').checked) {
              Utils.showFieldError('terms', 'You must agree to the terms and conditions');
              return false;
            }
            break;
        }
        return true;
      },
      validateForm() {
        const formData = new FormData(elements.form);
        let isValid = true;
        const fields = ['name', 'email', 'phone', 'password', 'confirmPassword', 'agreeTerms'];
        fields.forEach(field => {
          const value = field === 'agreeTerms' ?
            document.getElementById('agreeTerms').checked :
            formData.get(field);
          if (!this.validateField(field, value)) {
            isValid = false;
          }
        });
        return isValid;
      }
    };

    // --- Real-time Field Validation ---
    ['name', 'email', 'phone'].forEach(fieldId => {
      const field = document.getElementById(fieldId);
      if (field) {
        field.addEventListener('blur', function() {
          FormValidator.validateField(fieldId, this.value);
        });
      }
    });

    // --- Form Submission Handler ---
    elements.form.addEventListener('submit', async function(e) {
      e.preventDefault();
      if (AppState.isLoading) return;
      if (!FormValidator.validateForm()) {
        Utils.showError('Please fix the errors above and try again.');
        return;
      }
      // Collect form data
      const formData = new FormData(elements.form);
      let referral = Utils.sanitizeInput(formData.get('referral') || '');
      // If user pasted a full URL, extract the UID at the end
      if (referral.includes('/')) {
        referral = referral.split('ref=').pop().split('&')[0];
      }
      AppState.formData = {
        name: Utils.sanitizeInput(formData.get('name')),
        email: Utils.sanitizeInput(formData.get('email')).toLowerCase(),
        phone: Utils.sanitizeInput(formData.get('phone')),
        password: formData.get('password'),
        referral: referral
      };
      // Check if email already exists
      try {
        const signInMethods = await fetchSignInMethodsForEmail(auth, AppState.formData.email);
        if (signInMethods.length > 0) {
          Utils.showError('An account with this email already exists. Please use a different email or try logging in.');
          return;
        }
      } catch (error) {
        console.error('Error checking email:', error);
        Utils.showError('Unable to verify email. Please try again.');
        return;
      }
      // Initialize Paystack payment
      initializePayment();
    });

    // --- Paystack Payment Integration ---
    function initializePayment() {
      const transactionRef = Utils.generateTransactionRef();
      const handler = PaystackPop.setup({
        key: CONFIG.paystack.publicKey,
        email: AppState.formData.email,
        amount: CONFIG.paystack.amount,
        currency: CONFIG.paystack.currency,
        ref: transactionRef,
        metadata: {
          custom_fields: [
            { display_name: "Full Name", variable_name: "full_name", value: AppState.formData.name },
            { display_name: "Phone Number", variable_name: "phone_number", value: AppState.formData.phone }
          ]
        },
        callback: function(response) {
          handlePaymentSuccess(response, transactionRef);
        },
        onClose: function() {
          Utils.showError('Payment was cancelled. Please try again to complete your registration.');
        }
      });
      handler.openIframe();
    }

    // --- Handle Payment Success and Create User ---
    async function handlePaymentSuccess(response, transactionRef) {
      Utils.setLoading(true);
      try {
        const userCredential = await createUserWithEmailAndPassword(
          auth,
          AppState.formData.email,
          AppState.formData.password
        );
        const user = userCredential.user;
        await saveUserData(user.uid, response, transactionRef);
        // After successful registration and payment, redirect to thank you page
        localStorage.setItem('successMessage', 'Registration successful! Welcome to Freedom Network.');
        window.location.href = 'thankyou.html';
      } catch (error) {
        console.error('Registration error:', error);
        Utils.showError('Registration failed: ' + error.message);
      } finally {
        Utils.setLoading(false);
      }
    }

    // --- Save User Data to Firestore ---
    async function saveUserData(userId, paymentResponse, transactionRef) {
      const userData = {
        uid: userId,
        name: AppState.formData.name,
        email: AppState.formData.email,
        phone: AppState.formData.phone,
        referralCode: userId, // Use UID as referral code
        registrationDate: new Date(),
        paymentDetails: {
          reference: paymentResponse.reference,
          transactionRef: transactionRef,
          amount: CONFIG.paystack.amount,
          status: 'successful',
          paidAt: new Date()
        },
        accountStatus: 'active',
        directReferrals: 0,
        directEarnings: 0,
        poolEarnings: 0,
        matrixLevel: 1,
        matrixPosition: null,
        referredUsers: []
      };
      await setDoc(doc(db, 'users', userId), userData);

      // Handle referral bonus if referral code is provided
      if (AppState.formData.referral) {
        await handleReferralBonus(AppState.formData.referral, userId);
      }
    }

    // --- Handle Referral Bonus (4-level payout) ---
    async function handleReferralBonus(referralCode, newUserId) {
      try {
        // Level 1: Direct referrer, Levels 2-4: uplines
        let currentReferrerCode = referralCode;
        let payoutLevels = [
          { field: 'directEarnings', amount: 2000 }, // Level 1
          { field: 'poolEarnings', amount: 800 },    // Level 2
          { field: 'poolEarnings', amount: 400 },    // Level 3
          { field: 'poolEarnings', amount: 300 }     // Level 4
        ];

        for (let i = 0; i < payoutLevels.length; i++) {
          const referrerDocRef = doc(db, 'users', currentReferrerCode);
          const referrerDoc = await getDoc(referrerDocRef);
          if (referrerDoc.exists()) {
            const updateData = {};
            updateData[payoutLevels[i].field] = increment(payoutLevels[i].amount);
            if (i === 0) {
              // Only direct referrer gets directReferrals and referredUsers incremented
              updateData.directReferrals = increment(1);
              updateData.referredUsers = arrayUnion(newUserId);
            }
            await updateDoc(referrerDocRef, updateData);

            // Prepare for next level (get the next upline's referralCode)
            const referrerData = referrerDoc.data();
            currentReferrerCode = referrerData.referralCode;
          } else {
            break; // Stop if no further upline
          }
        }
      } catch (error) {
        console.error('Error processing referral:', error);
      }
    }

    // --- Initialization Log ---
    console.log('Freedom Network Registration System Initialized');
  </script>
</body>
</html>